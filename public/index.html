<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOLIS è¨±é¡˜ç‰†</title>

<script>
  // ===== æŠ½çéŸ³æ•ˆ =====
  const drawSound = new Audio("/sound/draw-loop.mp3");
  drawSound.loop = true;
  drawSound.volume = 0.7;

  const winSound = new Audio("/sound/win.mp3");
  winSound.loop = false;
  winSound.volume = 0.9;

  function playDrawSound(){
    drawSound.currentTime = 0;
    drawSound.play().catch(()=>{});
  }

  function stopDrawSound(){
    drawSound.pause();
    drawSound.currentTime = 0;
  }

  function playWinSound(){
    winSound.currentTime = 0;
    winSound.play().catch(()=>{});
  }

  // âœ… è§£é–éŸ³æ•ˆï¼ˆé‡è¦ï¼šé¿å…ç€è¦½å™¨æ“‹æ’­æ”¾ï¼‰
  let audioUnlocked = false;
  async function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;

    try{
      // ç”¨æ¥µå°éŸ³é‡æ’­æ”¾ 1ms ä¾†è§£é–
      const v1 = drawSound.volume, v2 = winSound.volume;
      drawSound.volume = 0.001;
      winSound.volume  = 0.001;

      await drawSound.play().catch(()=>{});
      drawSound.pause(); drawSound.currentTime = 0;

      await winSound.play().catch(()=>{});
      winSound.pause(); winSound.currentTime = 0;

      drawSound.volume = v1;
      winSound.volume  = v2;
    }catch(e){
      console.warn("unlockAudio failed", e);
    }
  }

  (function () {
    const p = new URLSearchParams(location.search);
    const isWall = p.get("wall") === "1";
    const isHost = p.get("host") === "1";
    const hasMedia = isWall || isHost;

    const root = document.documentElement;
    if (isWall) root.classList.add("wall-only");
    if (isHost) root.classList.add("is-host");
    if (hasMedia) root.classList.add("has-media");
  })();
</script>

  <style>
    :root{
      --bg:#f7f7f7;
      --text:#111;
      --muted:#666;
      --card:#fff;
      --orange:#ff6a00;
      --shadow: 0 10px 24px rgba(0,0,0,0.06);
      --shadow2: 0 10px 30px rgba(0,0,0,0.15);
    }
    *{ box-sizing:border-box; }

    body{
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
    }

    html.has-media body{
      width:1024px;
      height:768px;
      margin:0 auto;
      padding:10px;
      overflow:hidden;
      position:relative;
    }

    .header{
      width:100%;
      text-align:center;
      padding: 16px 10px 6px;
      margin: 0 auto;
    }
    .header h1{
      margin:0;
      font-size:36px;
      letter-spacing:.5px;
      line-height:1.1;
    }
    .header .hint{
      margin-top:6px;
      font-size:14px;
      font-weight:700;
      color:#444;
      letter-spacing:.4px;
      white-space: normal;
      line-height: 1.3;
      max-width: 92vw;
      margin-left:auto;
      margin-right:auto;
    }
    .header .divider{
      margin:8px auto 0;
      width: min(520px, 88vw);
      height:1px;
      background:#ddd;
    }

/* âœ… Header çœŸæ­£ç•«é¢ç½®ä¸­ï¼ˆä¸å— QR å½±éŸ¿ï¼‰ */
/* âœ… æŠ•å½±/ä¸»æŒï¼šHeader è¦–è¦ºç½®ä¸­ï¼ˆå·¦å³å„é ç•™ 200px æŠµéŠ· QRï¼‰ */
html.has-media .header{
  padding: 10px 200px 6px;   /* ä¸Š 10ã€å·¦å³ 200ã€ä¸‹ 6 */
  margin: 0;
  width: 100%;
  text-align: center;
  box-sizing: border-box;
}

/* âœ… å‰¯æ¨™ï¼šä¸è¦è·‘å‡ºè¢å¹•ï¼Œå¤ªé•·å°±çœç•¥ */
html.has-media .header .hint{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* âœ… åˆ†éš”ç·šç½®ä¸­ */
html.has-media .header .divider{
  width: 520px;
  margin-left: auto;
  margin-right: auto;
}


    .stage{
      margin: 12px auto 0;
      width: 100%;
      max-width: 560px;
      padding: 0 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    html.has-media .stage{
      margin-top:14px;
      margin-left:200px;
      width: calc(100% - 200px);
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      height: 560px;
      align-items: start;
      max-width: none;
      padding: 0;
    }

    .panel{
      background:transparent;
      height:100%;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .grid.input-area{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-bottom:10px;
    }
    input, button{
      font-size:16px;
      padding:12px 14px;
      border-radius:12px;
    }
    input{ border:1px solid #ccc; background:#fff; }
    button{
      background:#111;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    button:hover{ opacity:.92; }

    html.wall-only .input-area{ display:none; }

    .wall{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-top:0;
      border-top:0;
    }

    .item{ margin-bottom:14px; }
    .line{
      background: var(--card);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 5px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .line .name{ font-size:18px; font-weight:900; }

    .line .meta{
      font-size:12px;
      color:#888;
      font-weight:700;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }

    .line .msg{
      font-size:24px;
      font-weight:900;
      line-height:1.22;
      word-break:break-word;
    }

    @keyframes popIn{
      0%{ transform: translateY(10px) scale(.98); opacity:0; }
      60%{ transform: translateY(0) scale(1.02); opacity:1; }
      100%{ transform: translateY(0) scale(1); opacity:1; }
    }
    .item.is-new .line{ animation: popIn 420ms ease-out; outline:3px solid rgba(255,106,0,0.18); }

    .media-slot{
      height:100%;
      background:#000;
      border-radius:20px;
      overflow:hidden;
      box-shadow: 0 18px 44px rgba(0,0,0,0.18);
      display:none;
      position:relative;
    }
    .media-slot video{
      width:100%;
      height:100%;
      object-fit: contain;
      background:#000;
      display:block;
    }

    html.has-media .media-slot{
      display:block;
      height: 560px;
      align-self: start;
      aspect-ratio: 9 / 16;
      width: auto;
      max-width: 360px;
      flex: 0 0 auto;
    }
    html.has-media .media-slot video{
      width: 100%;
      height: 100%;
      object-fit: contain;
      background:#000;
      display:block;
    }

    .media-fallback{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,0.88);
      text-align:center;
      font-weight:900;
      letter-spacing:1px;
      line-height:1.35;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,106,0,0.35), transparent 40%),
        radial-gradient(circle at 70% 80%, rgba(255,255,255,0.08), transparent 45%),
        #0b0b0b;
    }

    .qr-box{
      position:fixed;
      left:10px;
      top:10px;
      background:#fff;
      padding:10px;
      border-radius:16px;
      box-shadow: var(--shadow2);
      text-align:center;
      z-index:999;
      display:none;
    }
    /* âœ… åªè¦ has-media å°±ä¸€å®šé¡¯ç¤º */
    html.has-media .qr-box{ display:block; }

    #qr{ width:154px; height:154px; }
    .qr-text{
      margin-top:8px;
      font-size:16px;
      font-weight:900;
      color:var(--orange);
      letter-spacing:1px;
    }

    .host-top{
      position:fixed;
      right:10px;
      top:10px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: var(--shadow2);
      z-index:998;
      display:none;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    html.is-host .host-top{ display:flex; }

    .host-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      min-height: 42px;
    }
    .pill.orange{
      border:none;
      background: linear-gradient(135deg, #ff7a00, #ff9a3c);
      color:#fff;
      box-shadow: 0 6px 16px rgba(255,122,0,0.35);
    }

    .count{
      font-size:14px;
      color:#555;
      font-weight:800;
      padding:0 4px;
      white-space:nowrap;
    }
    @keyframes countFlash {
      0% { color:var(--orange); transform:scale(1); }
      40%{ color:var(--orange); transform:scale(1.12); }
      100%{ color:#555; transform:scale(1); }
    }
    .count.flash{ animation:countFlash 600ms ease-out; }

    .controls{
      position:fixed;
      right:10px;
      bottom:10px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border-radius:16px;
      padding:10px 10px;
      box-shadow: var(--shadow2);
      z-index:998;
      display:none;
      gap:10px;
      align-items:center;
    }
    html.is-host .controls{ display:flex; }

    .icon-btn{
      width:46px;
      height:46px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:900;
      user-select:none;
    }
    .icon-btn:hover{ background:#f3f3f3; }

    .brand{
      text-align:center;
      margin: 18px auto 8px;
      opacity:.95;
      pointer-events:none;
    }
    .brand img{ max-height:88px; }

    html.has-media .brand{
      position:fixed;
      left:50%;
      bottom:12px;
      transform:translateX(-50%);
      z-index:997;
      margin:0;
    }
    html.has-media .brand img{ max-height:96px; }

    .draw-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .draw-box{
      width: min(920px, 94vw);
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.35);
      padding: 26px 26px 22px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.85;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,106,0,.55), transparent 30%),
        radial-gradient(circle at 80% 10%, rgba(0,0,0,.15), transparent 25%),
        radial-gradient(circle at 90% 70%, rgba(255,106,0,.35), transparent 28%),
        radial-gradient(circle at 30% 80%, rgba(0,0,0,.08), transparent 25%);
      mix-blend-mode: multiply;
      transform: scale(1.1);
    }
    .draw-close{
      position:absolute;
      right: 18px;
      top: 14px;
      border:none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      color: #666;
    }
    .draw-title{
      font-size: 18px;
      color: #666;
      margin-bottom: 12px;
      font-weight: 900;
      letter-spacing: 1px;
    }
    .draw-name{
      font-size: clamp(42px, 6vw, 86px);
      font-weight: 1000;
      margin: 6px 0 8px;
      color: #111;
    }
    .draw-sub{
      font-size: 16px;
      color: #777;
      margin-top: 10px;
    }
    .draw-list{
      margin-top: 10px;
      display: none;
      gap: 14px;
      justify-items: center;
    }
    .draw-pill{
      width: min(720px, 92%);
      background: #fff;
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      display:flex;
      align-items: baseline;
      gap: 14px;
      opacity: 0;
      transform: translateY(10px) scale(.98);
    }
    .draw-rank{
      font-weight: 1000;
      font-size: 18px;
      color: var(--orange);
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .draw-winner{
      font-weight: 1000;
      font-size: clamp(24px, 3.2vw, 40px);
      color:#111;
      word-break: break-word;
    }
    @keyframes revealIn{
      0% { opacity:0; transform: translateY(14px) scale(.97); }
      60%{ opacity:1; transform: translateY(0) scale(1.02); }
      100%{ opacity:1; transform: translateY(0) scale(1); }
    }
    .draw-pill.show{ animation: revealIn 520ms ease-out forwards; }
    /* å·¦ä¸‹ï¼šå…¨è¢å¹•æŒ‰éˆ•ï¼ˆä¸»æŒé é™å®šï¼‰ */
.fs-left{
  position: fixed;
  left: 12px;
  bottom: 12px;
  width: 52px;
  height: 52px;
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 900;
  cursor: pointer;
  user-select: none;
  z-index: 998;
}

/* åªåœ¨ä¸»æŒé é¡¯ç¤º */
html.is-host .fs-left{
  display: flex;
}

.fs-left:hover{
  background:#f3f3f3;
}

  </style>
</head>

<body>
  <div class="qr-box" id="qrBox">
    <canvas id="qr"></canvas>
    <div class="qr-text">æƒæåƒåŠ æŠ½ç</div>
  </div>
  
<!-- å·¦ä¸‹ï¼šå…¨è¢å¹•åˆ‡æ› -->
<div class="fs-left" id="fsBtn" title="å…¨è¢å¹• / è§£é™¤å…¨è¢å¹•">
  â›¶
</div>

  <div class="host-top" id="hostTop">
    <div class="host-actions">
      <div class="pill orange" id="draw3Btn" title="æŠ½ 3 å">ğŸ‰</div>
      <div class="pill" id="resetLocal" title="æ¸…ç©ºæœ¬æ©Ÿæ¸¬è©¦è³‡æ–™">ğŸ§¹</div>
    </div>
    <div class="count" id="playerCount">åƒèˆ‡è€…ï¼š0 äºº</div>
  </div>

  <div class="controls" id="controls">
    <input id="pickVideo" type="file" accept="video/*" multiple style="display:none;">
    <button class="icon-btn" id="pickVideoBtn" title="é¸å½±ç‰‡" aria-label="é¸å½±ç‰‡">ğŸ“</button>
    <button class="icon-btn" id="vidPlay" title="æ’­æ”¾" aria-label="æ’­æ”¾">â–¶ï¸</button>
    <button class="icon-btn" id="vidPause" title="æš«åœ" aria-label="æš«åœ">â¸ï¸</button>
    <button class="icon-btn" id="vidMute" title="éœéŸ³/æœ‰è²" aria-label="éœéŸ³/æœ‰è²">ğŸ”Š</button>
    <button class="icon-btn" id="vidNext" title="ä¸‹ä¸€æ”¯" aria-label="ä¸‹ä¸€æ”¯">â­ï¸</button>
  </div>

  <div class="header">
    <h1>SOLIS è¨±é¡˜ç‰†</h1>
    <div class="hint">æ­¡è¿è’è‡¨ SOLIS æ´»å‹•ç¾å ´ï½œæƒæ QR Code å®Œæˆç°½åˆ°ï½œç²¾ç¾å°ç¦®ç­‰ä½ ä¾†æŠ½</div>
    <div class="divider"></div>
  </div>

  <div class="stage">
    <div class="panel">
      <div class="grid input-area">
        <input id="tableNo" placeholder="è«‹è¼¸å…¥æ¡Œè™Ÿï¼ˆå¿…å¡«ï¼Œå¦‚ï¼š2ï¼‰">
        <input id="name" placeholder="è«‹è¼¸å…¥ç¨±å‘¼ï¼ˆå¿…å¡«ï¼‰">
        <input id="message" placeholder="è«‹è¼¸å…¥ä½ æƒ³å° SOLIS èªªçš„è©±ï½ï¼ˆä¾‹å¦‚ï¼šæˆ‘è¦ä¸­é ­çï¼‰">
        <button id="send">é€å‡º</button>
      </div>
      <div class="wall" id="wall"></div>
    </div>

    <div class="media-slot" id="mediaSlot">
      <video id="bgVideo" playsinline preload="metadata"></video>
      <div class="media-fallback" id="mediaFallback">
        SOLIS æ´»å‹•ç¾å ´<br/>æ’­æ”¾å€
      </div>
    </div>
  </div>

  <div class="brand">
    <img src="logo.png" alt="SOLIS">
  </div>

  <div class="draw-overlay" id="drawOverlay">
    <div class="draw-box" id="drawBox">
      <div class="confetti"></div>
      <button class="draw-close" id="drawClose" aria-label="Close">âœ•</button>
      <div class="draw-title">WINNERS</div>
      <div class="draw-name" id="drawName">æº–å‚™æŠ½çâ€¦</div>
      <div class="draw-list" id="drawList"></div>
      <div class="draw-sub" id="drawSub"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <script>
    const isWall = document.documentElement.classList.contains("wall-only");
    const isHost = document.documentElement.classList.contains("is-host");
    const hasMedia = document.documentElement.classList.contains("has-media");

    const socket = io();

    const wall = document.getElementById("wall");
    const nameEl = document.getElementById("name");
    const msgEl  = document.getElementById("message");
    const btn    = document.getElementById("send");
    const tableEl = document.getElementById("tableNo");

    const playerCountEl = document.getElementById("playerCount");
    const draw3Btn = document.getElementById("draw3Btn");

    const drawOverlay = document.getElementById("drawOverlay");


    const drawBox = document.getElementById("drawBox");
    const drawName = document.getElementById("drawName");
    const drawSub = document.getElementById("drawSub");
    const drawClose = document.getElementById("drawClose");
    const drawList = document.getElementById("drawList");

    const qrBox = document.getElementById("qrBox");

    const mediaSlot = document.getElementById("mediaSlot");
    const bgVideo = document.getElementById("bgVideo");
    const mediaFallback = document.getElementById("mediaFallback");

    const pickVideo = document.getElementById("pickVideo");
    const pickVideoBtn = document.getElementById("pickVideoBtn");

    const vidPlay = document.getElementById("vidPlay");
    const vidPause = document.getElementById("vidPause");
    const vidMute = document.getElementById("vidMute");
    const vidNext = document.getElementById("vidNext");

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    function now() {
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function normalizeTableNo(input) {
      const raw = String(input ?? "").trim();
      const zhMap = {
        "ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9,"å":10,
        "åä¸€":11,"åäºŒ":12,"åä¸‰":13,"åå››":14,"åäº”":15,"åå…­":16,"åä¸ƒ":17,"åå…«":18,"åä¹":19,"äºŒå":20,
        "å£¹":1,"è²³":2,"åƒ":3,"è‚†":4,"ä¼":5,"é™¸":6,"æŸ’":7,"æŒ":8,"ç–":9,"æ‹¾":10
      };
      const m = raw.match(/ç¬¬?\s*([å£¹è²³åƒè‚†ä¼é™¸æŸ’æŒç–æ‹¾ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*æ¡Œ?/);
      if (m && zhMap[m[1]] != null) return String(zhMap[m[1]]);
      const digits = raw.replace(/[^\d]/g, "");
      if (!digits) return "";
      const n = String(parseInt(digits, 10));
      return (n === "NaN" || n === "0") ? "" : n;
    }

    if (tableEl && !tableEl.disabled) {
      tableEl.addEventListener("blur", () => {
        const v = normalizeTableNo(tableEl.value);
        if (v) tableEl.value = v;
      });
    }

    let myToken = localStorage.getItem("event_token");
    if (!myToken) {
      myToken = (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random())).toString();
      localStorage.setItem("event_token", myToken);
    }

    const lockedName = localStorage.getItem("event_name");
    if (lockedName && nameEl) {
      nameEl.value = lockedName;
      nameEl.disabled = true;
    }

    const lockedTable = localStorage.getItem("event_table");
    if (lockedTable && tableEl) {
      tableEl.value = lockedTable;
      tableEl.disabled = true;
    }

    let sending = false;
    function sendCheckin(){
      if (!nameEl || !msgEl) return;
      if (sending) return;

      const tableNo = tableEl ? normalizeTableNo(tableEl.value) : "";
      const name = nameEl.value.trim();
      const message = msgEl.value.trim() || "æˆ‘å·²ç°½åˆ°";

      if (!tableNo) { alert("è«‹å…ˆè¼¸å…¥æ¡Œè™Ÿ"); return; }
      if (!name) { alert("è«‹å…ˆè¼¸å…¥åå­—"); return; }

      sending = true;
      setTimeout(() => (sending = false), 650);

      if (tableEl && !localStorage.getItem("event_table")) {
        localStorage.setItem("event_table", tableNo);
        tableEl.disabled = true;
      }
      if (!localStorage.getItem("event_name")) {
        localStorage.setItem("event_name", name);
        nameEl.disabled = true;
      }

      socket.emit("checkin", { token: myToken, tableNo, name, message, time: now() });

      msgEl.value = "";
      msgEl.focus();
    }

    if (btn) btn.addEventListener("click", sendCheckin);
    if (msgEl) {
      msgEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendCheckin();
        }
      });
    }

    socket.on("checkin_error", (e) => {
      alert(e?.message || "ç°½åˆ°å¤±æ•—ï¼Œè«‹é‡è©¦");
      if (e?.code === "DUP_NAME_SAME_TABLE") {
        localStorage.removeItem("event_name");
        if (nameEl) {
          nameEl.disabled = false;
          nameEl.value = "";
          nameEl.focus();
        }
      }
    });

    const wallQueue = [];
    let wallFlushTimer = null;

    function flushWall() {
      wallFlushTimer = null;
      if (!wall) return;
      if (wallQueue.length === 0) return;

      const frag = document.createDocumentFragment();
      const batch = wallQueue.splice(0, 12);

      for (const p of batch) {
        const div = document.createElement("div");
        div.className = "item is-new";
        div.innerHTML = `
          <div class="line">
            <span class="meta">${escapeHtml(p.tableNo ?? "")}æ¡Œ</span>
            <span class="name">${escapeHtml(p.name ?? "")}</span>
            <span class="meta">${escapeHtml(p.time ?? "")}ï¼š</span>
            <span class="msg">${escapeHtml(p.message ?? "")}</span>
          </div>
        `;
        frag.appendChild(div);
        setTimeout(() => div.classList.remove("is-new"), 900);
      }

      wall.prepend(frag);
      while (wall.children.length > 80) wall.removeChild(wall.lastChild);

      if (wallQueue.length > 0) scheduleFlush();
    }

    function scheduleFlush() {
      if (wallFlushTimer) return;
      wallFlushTimer = setTimeout(flushWall, 80);
    }

    socket.on("wall", (p) => {
      const normalized = {
        ...p,
        tableNo: normalizeTableNo(p?.tableNo ?? "") || String(p?.tableNo ?? "")
      };
      wallQueue.push(normalized);
      scheduleFlush();
    });

    let lastCount = 0;
    socket.on("participants_count", (d) => {
      const c = Number(d?.count ?? 0);
      if (!playerCountEl) return;
      playerCountEl.textContent = `åƒèˆ‡è€…ï¼š${c} äºº`;
      if (c > lastCount) {
        playerCountEl.classList.remove("flash");
        void playerCountEl.offsetWidth;
        playerCountEl.classList.add("flash");
      }
      lastCount = c;
    });

    // âœ… QR
    if (hasMedia) {
      try{
        new QRious({
          element: document.getElementById("qr"),
          value: window.location.origin,
          size: 154
        });
      }catch(e){
        console.warn("QR init failed", e);
      }
    }

    // ===== æŠ½ç overlayï¼ˆä¿æŒä½ åŸæœ¬ï¼‰=====
    function openDrawOverlay(){
      if (!drawOverlay || !drawName || !drawSub || !drawList || !drawBox) return;
      drawOverlay.style.display = "flex";
      drawName.style.display = "block";
      drawName.textContent = "æŠ½çä¸­â€¦";
      drawSub.textContent = "";
      drawList.style.display = "none";
      drawList.innerHTML = "";
      drawBox.classList.remove("win");
    }
    function closeDrawOverlay(){
      if (!drawOverlay) return;
      drawOverlay.style.display = "none";
    }
    if (drawClose) drawClose.addEventListener("click", closeDrawOverlay);
    if (drawOverlay) {
      drawOverlay.addEventListener("click", (e) => {
        if (e.target === drawOverlay) closeDrawOverlay();
      });
    }
    function rollingText(durationMs = 1200){
      if (!drawName || !drawOverlay) return;
      const frames = ["æŠ½çä¸­", "æŠ½çä¸­.", "æŠ½çä¸­..", "æŠ½çä¸­..."];
      let i = 0;
      const t = setInterval(() => {
        if (drawOverlay.style.display !== "flex") { clearInterval(t); return; }
        drawName.textContent = frames[i % frames.length];
        i++;
      }, 140);
      setTimeout(() => clearInterval(t), durationMs);
    }
    if (isHost && draw3Btn) {
draw3Btn.addEventListener("click", async () => {
  // âœ… å…ˆè§£é–ï¼ˆä¿è­‰å¾Œé¢ä¸­çéŸ³æ•ˆä¸æœƒè¢«æ“‹ï¼‰
  await unlockAudioOnce();

  openDrawOverlay();
  rollingText(1200);

  playDrawSound(); // ğŸ”Š æŠ½çä¸­éŸ³æ•ˆ
  socket.emit("host_draw", { n: 3 });
});


    }
    socket.on("draw_result", (r) => {
      if (!isHost) return;
      if (!drawName || !drawSub || !drawList || !drawBox) return;

      const winnersRaw = Array.isArray(r?.winners) ? r.winners : [];
      const winners = winnersRaw.map(w => {
        if (typeof w === "string") return { tableNo: "ï¼Ÿ", name: w };
        return { tableNo: String(w?.tableNo ?? "ï¼Ÿ"), name: String(w?.name ?? "ï¼Ÿ") };
      });

      openDrawOverlay();

      if (!r?.ok || winners.length === 0) {
        drawName.textContent = r?.reason || "æŠ½çå¤±æ•—";
        drawSub.textContent = "";
        return;
      }

      drawSub.textContent = `åƒèˆ‡è€…å…± ${Number(r.total ?? winners.length)} äºº`;
      drawName.textContent = "æº–å‚™æ­æ›‰â€¦";

   setTimeout(() => {
  stopDrawSound();

  drawName.style.display = "none";
  drawList.style.display = "grid";
  drawList.innerHTML = "";

winners.slice(0, 3).forEach((w, idx) => {
  const pill = document.createElement("div");
  pill.className = "draw-pill";
  pill.innerHTML = `
    <div class="draw-rank">ç¬¬ ${idx + 1} ä½</div>
    <div class="draw-winner">æ¡Œ ${escapeHtml(w.tableNo)}ï½œ${escapeHtml(w.name)}</div>
  `;
  drawList.appendChild(pill);

  setTimeout(() => {
    pill.classList.add("show");

    // âœ… åªåœ¨ç¬¬ä¸€åæ’­éŸ³æ•ˆ
if (idx === 0) {
  playWinSound();
}

  }, idx * 650);
});


  drawSub.textContent = "ğŸ‰ æ­å–œå¾—çï¼";
}, 800);

    });

    // ===== å½±ç‰‡ï¼ˆâœ… å·²ä¿®å¥½ï¼šä¸‹ä¸€é¦–ã€æ’åºã€æœ‰è²ã€é»å½±ç‰‡æ’­æ”¾ï¼‰=====
    function showFallback(on){
      if (!mediaFallback) return;
      mediaFallback.style.display = on ? "flex" : "none";
    }

    // has-media é¡¯ç¤ºå½±ç‰‡å€ï¼ˆä¿éšªï¼‰
    if (hasMedia && mediaSlot) {
      mediaSlot.style.display = "block";
      showFallback(true);
    }

    let playlist = [];     // [{ name, url }]
    let currentIndex = -1;

    function cleanupPlaylist() {
      playlist.forEach(v => {
        try { URL.revokeObjectURL(v.url); } catch(e){}
      });
      playlist = [];
      currentIndex = -1;
    }

    function loadVideoByIndex(index, autoplay = true) {
      if (!bgVideo) return;
      if (!playlist[index]) return;

      currentIndex = index;

      bgVideo.src = playlist[index].url;
      bgVideo.loop = false;

      // âœ… é è¨­æœ‰è²ï¼ˆç¬¬ä¸€æ¬¡éœ€è¦ä½¿ç”¨è€…äº’å‹•ï¼Œå¾ŒçºŒå°±å¯ä»¥ï¼‰
      bgVideo.muted = false;
      if (vidMute) vidMute.textContent = "ğŸ”Š";

      bgVideo.playsInline = true;
      bgVideo.preload = "auto";

      showFallback(false);

      bgVideo.load();

      if (autoplay) {
        bgVideo.play().catch(()=>{});
      }
    }

    function nextVideo() {
      if (!playlist.length) {
        alert("è«‹å…ˆæŒ‰å³ä¸‹ ğŸ“ é¸æ“‡å½±ç‰‡ï¼ˆå¯ä¸€æ¬¡å¤šé¸ï¼‰");
        return;
      }
      if (playlist.length === 1) {
        alert("ç›®å‰æ¸…å–®åªæœ‰ 1 æ”¯å½±ç‰‡ï¼Œç„¡æ³•åˆ‡ä¸‹ä¸€é¦–");
        return;
      }
      const next = (currentIndex + 1) % playlist.length;
      loadVideoByIndex(next, true);
    }

    // âœ… é»å½±ç‰‡ï¼šè§£é™¤éœéŸ³ + æ’­æ”¾ï¼ˆæ»¿è¶³ç€è¦½å™¨çš„ user gestureï¼‰
    if (bgVideo) {
      bgVideo.addEventListener("click", () => {
        bgVideo.muted = false;
        if (vidMute) vidMute.textContent = "ğŸ”Š";
        bgVideo.play().catch(()=>{});
      });
    }

    if (isHost && pickVideo && pickVideoBtn && bgVideo) {
      pickVideoBtn.addEventListener("click", () => pickVideo.click());

      pickVideo.addEventListener("change", () => {
        const files = Array.from(pickVideo.files || []);
        if (!files.length) return;

        cleanupPlaylist();

        // âœ… ä¾æª”åæ’åºï¼ˆAâ†’Z / 01â†’99ï¼‰
        files.sort((a, b) =>
          a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: "base" })
        );

        playlist = files.map(file => ({
          name: file.name,
          url: URL.createObjectURL(file)
        }));

        // âœ… å¾ç¬¬ 0 æ”¯é–‹å§‹ï¼Œä¸¦å˜—è©¦æ’­æ”¾ï¼ˆè‹¥è¢«æ“‹å°±é»å½±ç‰‡ä¸€ä¸‹ï¼‰
        loadVideoByIndex(0, true);
      });
    }

    if (isHost && bgVideo) {
      if (vidPlay)  vidPlay.addEventListener("click", () => {
        bgVideo.muted = false;
        if (vidMute) vidMute.textContent = "ğŸ”Š";
        bgVideo.play().catch(()=>alert("è«‹å…ˆæŒ‰ ğŸ“ é¸å½±ç‰‡"));
      });
      if (vidPause) vidPause.addEventListener("click", () => bgVideo.pause());

      if (vidMute) {
        vidMute.textContent = bgVideo.muted ? "ğŸ”‡" : "ğŸ”Š";
        vidMute.addEventListener("click", () => {
          bgVideo.muted = !bgVideo.muted;
          vidMute.textContent = bgVideo.muted ? "ğŸ”‡" : "ğŸ”Š";
        });
      }

      if (vidNext)  vidNext.addEventListener("click", nextVideo);
    }

    const resetBtn = document.getElementById("resetLocal");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ­¤è£ç½®çš„æ¸¬è©¦ç¶å®šè³‡æ–™å—ï¼Ÿ")) return;
        localStorage.removeItem("event_name");
        localStorage.removeItem("event_table");
        localStorage.removeItem("event_token");
        location.reload();
      });
    }
    // ================================
// å…¨è¢å¹•åˆ‡æ›ï¼ˆä¸»æŒé ï½œå·¦ä¸‹ï¼‰
// ================================
const fsBtn = document.getElementById("fsBtn");

function isFullscreen() {
  return !!document.fullscreenElement;
}

async function enterFullscreen() {
  await document.documentElement.requestFullscreen();
}

async function exitFullscreen() {
  await document.exitFullscreen();
}

function syncFsIcon() {
  if (!fsBtn) return;
  const on = isFullscreen();
  fsBtn.textContent = on ? "â¤¢" : "â›¶";
  fsBtn.title = on ? "è§£é™¤å…¨è¢å¹•" : "å…¨è¢å¹•";
}

if (isHost && fsBtn) {
  fsBtn.addEventListener("click", async () => {
    try {
      if (!isFullscreen()) {
        await enterFullscreen();
      } else {
        await exitFullscreen();
      }
    } catch (e) {
      alert("å…¨è¢å¹•è¢«ç€è¦½å™¨é˜»æ“‹ï¼Œè«‹ç¢ºèªæ˜¯ç”±é»æ“Šè§¸ç™¼");
    } finally {
      syncFsIcon();
    }
  });

  document.addEventListener("fullscreenchange", syncFsIcon);
  syncFsIcon();
}

  </script>
</body>
</html>
